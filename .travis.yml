language: cpp

os: linux
dist: bionic

env:
  - TARGET="Native"
  - TARGET="WebAssembly"

addons:
  apt:
    sources:
    - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-10 main'
      key_url: 'https://apt.llvm.org/llvm-snapshot.gpg.key'
    - sourceline: 'deb https://apt.kitware.com/ubuntu/ xenial main'
      key_url: 'https://apt.kitware.com/keys/kitware-archive-latest.asc'
    update: true
    packages:
    - clang++-10
    - clang-10
    - libc++-10-dev
    - libc++abi-10-dev
    - cmake
    - cmake-data
    - ninja-build

script:
  # Make sure we have the required versions
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -yq update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -yq install cmake cmake-data clang-10 clang++-10 libc++-10-dev libc++abi-10-dev
  
  # Fix issue caused by previous cmake version.
  - alias cmake='/usr/bin/cmake'
  - /usr/bin/cmake --version
  
  # If native, build and run tests.
  #
  - |
     if [ $TARGET == "Native" ]; then
       mkdir build
       cd build
       /usr/bin/cmake -G Ninja -DCMAKE_C_COMPILER=clang-10 -DCMAKE_CXX_COMPILER=clang++-10 -DCMAKE_CXX_FLAGS="-stdlib=libc++" -DVTIL_BUILD_TESTS=ON ..
       ninja -j8
       ./VTIL-Tests/VTIL-Tests
     fi
  
  # If WebAssembly, just build for it.
  #
  - |
     if [ $TARGET == "WebAssembly" ]; then
       cd ..
       git clone https://github.com/emscripten-core/emsdk.git
       cd emsdk
       ./emsdk install latest
       ./emsdk activate latest
       source ./emsdk_env.sh
       cd ..
       mkdir build-www
       cd build-www
       emcmake /usr/bin/cmake -G Ninja -DCMAKE_CXX_FLAGS="-std=c++20" ..
       ninja -j8
     fi
